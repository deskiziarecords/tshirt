<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fabric.js Textbox Masking</title>
    <style>
        #canvasContainer {
            position: relative;
        }

        canvas {
            border: 1px solid #ccc;
        }
    </style>
    <!-- Include Fabric.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/3.6.1/fabric.min.js"></script>
</head>

<body>
    <div id="canvasContainer">
        <canvas id="ex2" width="600" height="350"></canvas>
    </div>

    <script>
    // (function () {
    //     var canvas = new fabric.Canvas('ex2');
    //     var clipPath = new fabric.Circle({
    //         radius: 100,
    //         top: -100,
    //         left: -100
    //     });
    //     var group = new fabric.Group([
    //         new fabric.Rect({ width: 100, height: 100, fill: 'red' }),
    //         new fabric.Rect({ width: 100, height: 100, fill: 'yellow', left: 100 }),
    //         new fabric.Rect({ width: 100, height: 100, fill: 'blue', top: 100 }),
    //         new fabric.Rect({ width: 100, height: 100, fill: 'green', left: 100, top: 100 })
    //     ]);
    //     group.clipPath = clipPath;
    //     canvas.add(group);
    // })()


(async function () {

        function loadImage(url) {
            return new Promise((resolve, reject) => {
                fabric.Image.fromURL(url, (img) => {
                    if (img) {
                        resolve(img);
                    } else {
                        reject(new Error('Failed to load image.'));
                    }
                });
            });
        }

        var canvas = new fabric.Canvas('ex2');
        var clipPath = new fabric.Circle({
            radius: 80,
            top: 0,
            left: 0
        });
        var clipPathRect = new fabric.Rect({
            width: 160,
            height: 320,
            top: 0,
            left: 0
        });
        // var group = new fabric.Group([
        //     new fabric.Rect({ width: 100, height: 100, fill: 'red' }),
        //     new fabric.Rect({ width: 100, height: 100, fill: 'yellow', left: 100 }),
        //     new fabric.Rect({ width: 100, height: 100, fill: 'blue', top: 100 }),
        //     new fabric.Rect({ width: 100, height: 100, fill: 'green', left: 100, top: 100 })
        // ]);
        // group.clipPath = clipPath;
        // var text = new fabric.Text ("This is some text", { left: 0, top: 0, fontSize: 24, fill: 'black', textAlign:'left'});
        // var text2 = new fabric.Text("", { left: 0, top: 0, fontSize: 24, fill: 'black', textAlign: 'left' });
        const imageUrl = './Peach_the_pet_hamster.jpg';

        const img = await loadImage (imageUrl);
        img.set({ left: 0, top: 0});

        var group = new fabric.Group([img, new fabric.Text("This is some text", { left: 100, top: 100, fontSize: 50, fill: 'black', textAlign: 'left', angle: -10 }),
                                      new fabric.Text("Another text", { left: 10, top: 0, fontSize: 24, fill: 'black', textAlign: 'left', angle: 45 })
                        ]);
        
        // Manually compute the bounding box - SH: I believed it only returns half of the width and height
        const groupBoundingBox = group.getObjects().reduce((acc, obj) => {
            const objBoundingBox = obj.getBoundingRect();
            console.log ("objBoundingBox: ", objBoundingBox);

            // finding the extreme coordinate points from the center point
            acc.extremeX = Math.max (Math.abs(acc.extremeX), Math.abs(objBoundingBox.left));
            acc.extremeY = Math.max(Math.abs(acc.extremeY), Math.abs(objBoundingBox.top));
            acc.width = acc.extremeX * 2;
            acc.height = acc.extremeY * 2;
            return acc;
        }, { width: 0, height: 0, extremeX: 0, extremeY: 0 });

        // clipPath from the center
        clipPathRect.set({ left: groupBoundingBox.width / -2 + 10, top: groupBoundingBox.height / -2});
        group.clipPath = clipPathRect;
        
        canvas.add(group);
    })()


// good example of bounding width
// (function () {
//         var canvas = new fabric.Canvas('ex2');
//     const rect = new fabric.Rect({
//         width: 100,
//         height: 50,
//         left: 50,
//         top: 50,
//         fill: 'blue',
//         angle: 45, // Rotate the object by 45 degrees
//     });

//     //const boundingBox = rect.getBoundingRect();

//     canvas.add(rect);
//     rect.on('modified', () => {
//         const boundingBox = rect.getBoundingRect();
//         console.log('Rotated Width:', boundingBox.width);
//         console.log('Rotated Height:', boundingBox.height);
//     });
// })()

    </script>
</body>

</html>